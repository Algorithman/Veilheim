name: Create Release

on:
  push:
    tags:
      - "v*"

jobs:
  build_release:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: 'development'
          token: ${{ secrets.PUSHY }}

      - name: Get the version
        id: get_version
        shell: bash
        run: |
          echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}
          echo ::set-output name=VERSION_NUMBER::${GITHUB_REF/refs\/tags\/v/}

      - name: Get powershell
        run: |
          sudo apt-get update
          sudo apt-get install -y powershell

      - name: Setup dotnet for build
        uses: actions/setup-dotnet@v1.7.2
        with:
          dotnet-version: 5.0.x

      - name: Install NuGet
        uses: nuget/setup-nuget@v1

      - name: Restore project dependencies
        run: |
          nuget restore Veilheim.sln
          dotnet restore Veilheim/Veilheim.csproj

      - name: Restore tools
        run: |
          dotnet tool restore

      - name: Install SteamCMD
        uses: CyberAndrii/setup-steamcmd@v1

      - name: Prepare Valheim dependencies
        run: Invoke-WebRequest -Uri https://valheim.thunderstore.io/package/download/denikson/BepInExPack_Valheim/5.4.1001/ -OutFile Bepinex.zip


      - name: Unzip BepinExPack
        run: |
          7z x Bepinex.zip -oBepInExRaw
          steamcmd +login anonymous +force_install_dir D:\a\Veilheim\Veilheim\VHINSTALL +app_update 896660 validate +exit
          mv D:\a\Veilheim\Veilheim\VHINSTALL/valheim_server_Data/ D:\a\Veilheim\Veilheim\VHINSTALL/valheim_Data/ 
          cp -Recurse BepInExRaw/BepInExPack_Valheim/* D:\a\Veilheim\Veilheim\VHINSTALL/

      - name: Create Environment.props
        run: |
          echo "<?xml version=""1.0"" encoding=""utf-8""?><Project ToolsVersion=""Current"" xmlns=""http://schemas.microsoft.com/developer/msbuild/2003""><PropertyGroup><VALHEIM_INSTALL>D:/a/Veilheim/Veilheim/VHINSTALL</VALHEIM_INSTALL></PropertyGroup></Project>" > Environment.props

      - name: Create DoPrebuild.props
        run: |
          echo "<?xml version=""1.0"" encoding=""utf-8""?><Project ToolsVersion=""Current"" xmlns=""http://schemas.microsoft.com/developer/msbuild/2003""><PropertyGroup><ExecutePrebuild>true</ExecutePrebuild></PropertyGroup></Project>" > DoPrebuild.props

      - name: Create version.props
        run: |
          sed -e 's/\[assembly: AssemblyVersion(".*")\]/[assembly: AssemblyVersion(""${{ steps.get_version.outputs.VERSION_NUMBER }}.0"")]/' Veilheim/Properties/AssemblyInfo.cs > tempAssemblyInfo.cs && mv -Force tempAssemblyInfo.cs Veilheim/Properties/AssemblyInfo.cs
          sed -e 's/\[assembly: AssemblyFileVersion(".*")\]/[assembly: AssemblyFileVersion(""${{ steps.get_version.outputs.VERSION_NUMBER }}.0"")]/' Veilheim/Properties/AssemblyInfo.cs > tempAssemblyInfo.cs && mv -Force tempAssemblyInfo.cs Veilheim/Properties/AssemblyInfo.cs
          sed -e 's/public const string PluginVersion = ".*";/public const string PluginVersion = ""${{ steps.get_version.outputs.VERSION_NUMBER }}"";/' Veilheim/Veilheim.cs > tempVeilheim.cs && mv -Force tempVeilheim.cs Veilheim/Veilheim.cs

      - name: Build solution
        run: |
          mkdir D:\a\Veilheim\Veilheim\Veilheim\bin\Release
          cp BepInExRaw/BepInExPack_Valheim/BepInEx/core/* D:\a\Veilheim\Veilheim\Veilheim\bin\Release
          dotnet build Veilheim.sln --configuration Release
          mv Veilheim/bin/Release/Veilheim.dll Veilheim.dll

      - name: Push version update to master
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git add Veilheim/Properties/AssemblyInfo.cs
          git add Veilheim/Veilheim.cs
          git commit -m "deploy: Released ${{ steps.get_version.outputs.VERSION }}"
          git push https://${{ secrets.PUSHY }}@github.com/sirskunkalot/Veilheim HEAD:development
          git push https://${{ secrets.PUSHY }}@github.com/sirskunkalot/Veilheim development:master

      - name: Create GH Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Veilheim.dll
            release/Unix.zip
            release/Windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
